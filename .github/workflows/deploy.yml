name: Deploy Affected Apps

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  check-affected:
    runs-on: ubuntu-latest
    outputs:
      myhost-affected: ${{ steps.affected.outputs.myhost }}
      mymemory-affected: ${{ steps.affected.outputs.mymemory }}
      mymotus-affected: ${{ steps.affected.outputs.mymotus }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies (minimal for nx)
        run: npm install --prefer-offline --no-audit --no-fund
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'

      - name: Check affected projects
        id: affected
        run: |
          # Get affected projects (compare with previous commit)
          AFFECTED=$(npx nx show projects --affected --base=HEAD~1 --head=HEAD)

          echo "Affected projects:"
          echo "$AFFECTED"

          # Check if myhost is affected
          if echo "$AFFECTED" | grep -q "myhost"; then
            echo "myhost=true" >> $GITHUB_OUTPUT
            echo "✅ myhost is affected"
          else
            echo "myhost=false" >> $GITHUB_OUTPUT
            echo "⏭️  myhost is not affected"
          fi

          # Check if mymemory is affected
          if echo "$AFFECTED" | grep -q "mymemory"; then
            echo "mymemory=true" >> $GITHUB_OUTPUT
            echo "✅ mymemory is affected"
          else
            echo "mymemory=false" >> $GITHUB_OUTPUT
            echo "⏭️  mymemory is not affected"
          fi

          if echo "$AFFECTED" | grep -q "mymotus"; then
            echo "mymotus=true" >> $GITHUB_OUTPUT
            echo "✅ mymotus is affected"
          else
            echo "mymotus=false" >> $GITHUB_OUTPUT
            echo "⏭️  mymotus is not affected"
          fi

  deploy-myhost:
    needs: check-affected
    if: needs.check-affected.outputs.myhost-affected == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Determine environment and UUID
        id: env
        run: |
          if [ "${{ github.ref_name }}" = "develop" ]; then
            echo "environment=STA"
            echo "uuid=${{ secrets.COOLIFY_UUID_MYHOST_STA }}"
            echo "uuid=${{ secrets.COOLIFY_UUID_MYHOST_STA }}" >> $GITHUB_OUTPUT
          else
            echo "environment=Production"
            echo "uuid=${{ secrets.COOLIFY_UUID_MYHOST }}"
            echo "uuid=${{ secrets.COOLIFY_UUID_MYHOST }}" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Coolify deployment for myhost
        run: |
          BRANCH="${{ github.ref_name }}"
          if [ "$BRANCH" = "develop" ]; then
            ENV_NAME="STA"
            UUID="${{ secrets.COOLIFY_UUID_MYHOST_STA }}"
          else
            ENV_NAME="Production"
            UUID="${{ secrets.COOLIFY_UUID_MYHOST }}"
          fi

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.COOLIFY_URL }}/api/v1/deploy?uuid=$UUID&force=true"
          echo "✅ Triggered deployment for myhost ($ENV_NAME)"

  deploy-mymemory:
    needs: check-affected
    if: needs.check-affected.outputs.mymemory-affected == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Coolify deployment for mymemory
        run: |
          BRANCH="${{ github.ref_name }}"
          if [ "$BRANCH" = "develop" ]; then
            ENV_NAME="STA"
            UUID="${{ secrets.COOLIFY_UUID_MYMEMORY_STA }}"
          else
            ENV_NAME="Production"
            UUID="${{ secrets.COOLIFY_UUID_MYMEMORY }}"
          fi

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.COOLIFY_URL }}/api/v1/deploy?uuid=$UUID&force=true"
          echo "✅ Triggered deployment for mymemory ($ENV_NAME)"

  deploy-mymotus:
    needs: check-affected
    if: needs.check-affected.outputs.mymotus-affected == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Coolify deployment for mymotus
        run: |
          BRANCH="${{ github.ref_name }}"
          if [ "$BRANCH" = "develop" ]; then
            ENV_NAME="STA"
            UUID="${{ secrets.COOLIFY_UUID_MYMOTUS_STA }}"
          else
            ENV_NAME="Production"
            UUID="${{ secrets.COOLIFY_UUID_MYMOTUS }}"
          fi

          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.COOLIFY_URL }}/api/v1/deploy?uuid=$UUID&force=true"
          echo "✅ Triggered deployment for mymotus ($ENV_NAME)"
